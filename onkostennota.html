<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Onkostennota – Chiro Kattenbos</title>
  <link rel="stylesheet" href="style.css?v=20250926" />
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" sizes="any" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Zelfde Firebase config als index.html
    const firebaseConfig = {
      apiKey: "AIzaSyC-UaXhh5juhV4raXWnzku9fSZZD75-y9w",
      authDomain: "uitgavebeheerch.firebaseapp.com",
      databaseURL: "https://uitgavebeheerch-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "uitgavebeheerch",
      storageBucket: "uitgavebeheerch.firebasestorage.app",
      messagingSenderId: "461673562296",
      appId: "1:461673562296:web:d90a026cd685400139f44d",
      measurementId: "G-K8NYLSE5EF"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Helpers
    function parseEuro(str){
      if (typeof str !== 'string') return NaN;
      const clean = str.trim().replace(/\s/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',', '.');
      return Number(clean);
    }
    function formatEuro(v){
      return new Intl.NumberFormat('nl-BE',{ style:'currency', currency:'EUR' }).format(+v || 0);
    }

    const LEIDINGSKAS_IBAN = 'BE38 7350 3401 6672';
    const CHIRO_NAAM = 'Chiro Kattenbos';
    const CHIRO_ADRES = 'Oude Diestersebaan 1A, 3920 Lommel';

    async function allocateReference(){
      const jaar = new Date().getFullYear();
      const docRef = db.collection('refs').doc(String(jaar));
      let refStr = `${jaar}-TEMP`;
      try {
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(docRef);
          let next = 1;
          if (snap.exists && typeof snap.data().last === 'number') next = snap.data().last + 1;
          tx.set(docRef, { last: next }, { merge: true });
          refStr = `${jaar}-${String(next).padStart(4,'0')}`;
        });
      } catch(e){ console.warn('Kon referentie niet alloceren, gebruik TEMP', e); }
      const el = document.getElementById('referentie');
      if (el) el.value = refStr;
      return refStr;
    }

    function selectedIban(){
      const keuze = document.querySelector('input[name="rekeningKeuze"]:checked')?.value || 'leidingskas';
      if (keuze === 'leidingskas') return LEIDINGSKAS_IBAN;
      const custom = document.getElementById('ibanCustom')?.value?.trim() || '';
      return custom;
    }

    function updateIbanUI(){
      const keuze = document.querySelector('input[name="rekeningKeuze"]:checked')?.value || 'leidingskas';
      const customWrap = document.getElementById('ibanCustomWrap');
      if (customWrap) customWrap.style.display = (keuze === 'custom') ? 'block' : 'none';
    }

    // Auth guard: alleen financieel
    firebase.auth().onAuthStateChanged(async (user)=>{
      const login = document.getElementById('loginBlock');
      const page  = document.getElementById('page');
      if (!user){ login.style.display='block'; page.style.display='none'; return; }
      try {
        const snap = await db.collection('gebruikers').doc(user.uid).get();
        const data = snap.exists ? snap.data() : {};
        if (data.rol !== 'financieel'){
          alert('Deze pagina is enkel voor financieel.');
          location.href = 'index.html';
          return;
        }
        // Prefill
        // Contact e-mail optioneel voor verzenden: laat leeg, maar mag vooraf ingevuld worden met eigen e-mail indien gewenst
        document.getElementById('contactEmail').value = '';
        document.getElementById('contactPhone').value = '';
        // Activeer standaard Leidingskas rekening
        const r = document.querySelector('input[name="rekeningKeuze"][value="leidingskas"]');
        if (r) r.checked = true; updateIbanUI();
        // Allocatie referentie (readonly)
        await allocateReference();
        login.style.display='none'; page.style.display='block';
      } catch (e){ console.error(e); alert('Kon gebruikersrechten niet laden.'); location.href='index.html'; }
    });

    async function handleLogin(){
      const em = document.getElementById('loginEmail').value.trim();
      const pw = document.getElementById('loginPass').value;
      const fout = document.getElementById('loginFout');
      fout.textContent = '';
      try { await firebase.auth().signInWithEmailAndPassword(em, pw); }
      catch(err){ fout.textContent = err?.message || 'Login mislukt.'; }
    }

    async function addLogo(doc){
      try {
        const res = await fetch('chiro-logo.png');
        if (!res.ok) return;
        const blob = await res.blob();
        const dataUrl = await new Promise((resolve, reject)=>{
          const fr = new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(blob);
        });
        doc.addImage(dataUrl, 'PNG', 15, 10, 28, 28);
        doc.setFontSize(12); doc.text('Chiro Kattenbos', 48, 20);
      } catch(e){ console.warn('Logo niet toegevoegd:', e); }
    }

    async function generatePdf(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Header
      await addLogo(doc);
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('Onkostennota', 105, 18, { align:'center' });
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.text(`${CHIRO_NAAM} — ${CHIRO_ADRES}`, 105, 26, { align:'center' });

      // Gegevens
      const ref = document.getElementById('referentie').value || await allocateReference();
      const naam = document.getElementById('betaler').value.trim();
      const oms  = document.getElementById('omschrijving').value.trim();
      const bedragRaw = document.getElementById('bedrag').value.trim();
      const bedrag = parseEuro(bedragRaw);
      const dnota = document.getElementById('datumNota').value || new Date().toISOString().slice(0,10);
      const iban  = selectedIban();
      const email = document.getElementById('contactEmail').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();

      if (!naam || !oms || isNaN(bedrag) || !dnota || !iban){ alert('Vul Naam, Omschrijving, Bedrag, Datum en Rekeningnummer in.'); return; }

      // Due date: 14 dagen na dnota
      const d = new Date(dnota);
      const verval = new Date(d.getTime() + 14*24*60*60*1000);
      const vervalStr = verval.toISOString().slice(0,10);

      let y=38; const line=(l,v)=>{ doc.setFont('helvetica','bold'); doc.text(l+':',12,y); doc.setFont('helvetica','normal'); doc.text(v||'-',48,y); y+=6; };
      line('Referentie', ref);
      line('Naam betaler', naam);
      line('Omschrijving', oms);
      line('Bedrag', formatEuro(bedrag));
      line('Datum', dnota);
      line('IBAN bestemming', iban);
      if (email) line('Contact e-mail', email);
      if (phone) line('Contact telefoon', phone);

      y += 2;
      doc.setFont('helvetica','bold');
      doc.text(`Gelieve uiterlijk binnen 14 dagen (vóór ${vervalStr}) te betalen.`, 12, y);
      y += 6;
      doc.setFont('helvetica','normal');
      doc.text(`Overschrijving naar ${iban} met vermelding van referentie ${ref}.`, 12, y);
      y += 12;
      doc.text('Met vriendelijke groet,', 12, y); y += 6;
      doc.text(CHIRO_NAAM, 12, y); y += 6;
      doc.text(CHIRO_ADRES, 12, y);

      const fname = `Onkostennota-${ref}.pdf`;
      doc.save(fname);
    }

    function openEmailDraft(){
      const ref = document.getElementById('referentie').value;
      const email = document.getElementById('contactEmail').value.trim();
      const naam = document.getElementById('betaler').value.trim();
      const bedrag = parseEuro(document.getElementById('bedrag').value.trim());
      const dnota = document.getElementById('datumNota').value || new Date().toISOString().slice(0,10);
      const d = new Date(dnota); const verval = new Date(d.getTime() + 14*24*60*60*1000); const vervalStr = verval.toISOString().slice(0,10);
      const iban = selectedIban();

      const subject = encodeURIComponent(`Onkostennota ${ref} – ${CHIRO_NAAM}`);
      const lines = [
        `Beste ${naam || ''},`,
        '',
        `In bijlage vindt u de onkostennota met referentie ${ref}.`,
        `Gelieve ${formatEuro(bedrag)} over te schrijven naar ${iban} met vermelding van de referentie ${ref}.`,
        `Betaaltermijn: uiterlijk ${vervalStr} (14 dagen na ${dnota}).`,
        '',
        `Met vriendelijke groet,`,
        `${CHIRO_NAAM}`,
        `${CHIRO_ADRES}`
      ];
      const body = encodeURIComponent(lines.join('\n'));
      const to = email || '';
      const mailto = `mailto:${to}?subject=${subject}&body=${body}`;
      window.location.href = mailto;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // UI handlers
      document.getElementById('genPdf').addEventListener('click', ()=>{ generatePdf(); });
      document.querySelectorAll('input[name="rekeningKeuze"]').forEach(el=> el.addEventListener('change', updateIbanUI));
      document.getElementById('navLogout').addEventListener('click', ()=> firebase.auth().signOut().then(()=> location.href='index.html'));
      // Init rekening UI
      updateIbanUI();
      document.getElementById('btnEmail').addEventListener('click', openEmailDraft);
    });
  </script>

  <style>
    .container { max-width: 1000px; margin: 0 auto; padding: 1rem; }
    .card { background: var(--card-bg, rgba(255,255,255,0.04)); border-radius: 12px; padding: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-grid .full { grid-column: 1 / -1; }
    .btn { padding: 10px 14px; border: 0; border-radius: 8px; background: #2563eb; color: #fff; cursor: pointer; }
    .btn.sm { padding: 6px 10px; font-size: 0.9rem; background: #4b5563; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid rgba(255,255,255,0.08); padding: 8px; }
    .actions { display: flex; gap: 8px; }
    @media (max-width: 800px) { .form-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <nav id="mainNav">
    <span>Chiro Kattenbos</span>
    <a href="index.html">Home</a>
    <button id="navLogout" style="margin-left:auto;">Uitloggen</button>
  </nav>

  <div class="container">
    <!-- Login fallback -->
    <div id="loginBlock" class="card" style="display:none;">
      <h2>Inloggen</h2>
      <div class="form-grid">
        <input type="email" id="loginEmail" placeholder="E-mailadres" />
        <input type="password" id="loginPass" placeholder="Wachtwoord" />
        <button class="btn" onclick="handleLogin()">Inloggen</button>
        <p id="loginFout" class="full" style="color:#ef4444;"></p>
      </div>
    </div>

    <!-- Pagina -->
    <div id="page" style="display:none;">
      <div class="card" style="margin-bottom:1rem;">
        <h1 style="margin:0 0 .5rem 0; display:flex; align-items:center; gap:10px;">
          <img id="logo" src="chiro-logo.png" alt="Chiro logo" style="width:32px; height:32px; object-fit:contain;" />
          Onkostennota
        </h1>
        <p>Vul de gegevens in en klik op Genereren. Deze kostennota vermeldt automatisch dat we {CHIRO_NAAM} zijn, het adres en een betaaltermijn van 14 dagen.</p>
      </div>

      <div class="card" style="margin-bottom:1rem;">
        <div class="form-grid">
          <input type="text" id="betaler" class="full" placeholder="Voor- en achternaam betaler" />
          <input type="text" id="omschrijving" class="full" placeholder="Reden / omschrijving" />
          <input type="text" id="bedrag" inputmode="decimal" pattern="^\d+(?:[\.,]\d{1,2})?$" placeholder="Bedrag, bv. 12,30" />
          <input type="date" id="datumNota" />
          <input type="text" id="referentie" class="full" placeholder="Referentie (automatisch)" readonly />

          <div class="full" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
            <label style="margin-right:10px;">Rekeningnummer:</label>
            <label><input type="radio" name="rekeningKeuze" value="leidingskas" checked> Leidingskas (${LEIDINGSKAS_IBAN})</label>
            <label><input type="radio" name="rekeningKeuze" value="custom"> Eigen rekeningnummer</label>
          </div>
          <div id="ibanCustomWrap" class="full" style="display:none;">
            <input type="text" id="ibanCustom" placeholder="IBAN (BE00 0000 0000 0000)" />
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:1rem;">
        <h3 style="margin-top:0;">Verzenden (optioneel)</h3>
        <div class="form-grid">
          <input type="email" id="contactEmail" placeholder="E-mailadres ontvanger" />
          <input type="tel" id="contactPhone" placeholder="Telefoonnummer ontvanger" />
        </div>
        <div class="actions" style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn" id="genPdf">Genereren</button>
          <button class="btn sm" type="button" id="btnEmail">Maak e-mail</button>
          <span style="opacity:.8;">E-mail opent in je eigen mailprogramma. Verzenden via een echt noreply-adres kan later via een maildienst.</span>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="sw-register.js"></script>
</html>


