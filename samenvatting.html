<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Samenvatting â€“ Chiro Kattenbos</title>
  <link rel="stylesheet" href="style.css?v=20250926" />
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyC-UaXhh5juhV4raXWnzku9fSZZD75-y9w",
    authDomain: "uitgavebeheerch.firebaseapp.com",
    projectId: "uitgavebeheerch",
    storageBucket: "uitgavebeheerch.firebasestorage.app"
  };
  firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <nav id="mainNav">
    <span>Chiro Kattenbos</span>
    <a href="index.html">Home</a>
    <a id="navBeheer" href="gebruikersbeheer.html">Gebruikersbeheer</a>
    <button id="navTheme" title="Schakel thema" style="display:none;">ðŸŒ™</button>
    <button id="navLogout" class="push-right">Uitloggen</button>
  </nav>

  <div class="container">
  <div id="loginScherm">
    <h2>Inloggen</h2>
    <input type="email" id="loginEmail" placeholder="E-mailadres" required />
    <input type="password" id="loginWachtwoord" placeholder="Wachtwoord" required />
    <button id="loginKnop">Inloggen</button>
    <p id="loginFout" style="color:red;"></p>
  </div>

  <div id="appInhoud" style="display:none;">
    <h1>Samenvatting per groep</h1>
    <p id="gebruikerInfo"></p>
    <table id="groepSamenvattingTabel">
      <thead>
        <tr>
          <th>Groep</th>
          <th>Leden</th>
          <th>Totaal (â‚¬)</th>
          <th>â‚¬ per kind</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="samenvattingStatus" style="font-style:italic; color:#555; margin-top:8px;"></p>
  </div>
  </div>

  <script>
  // Early theme from localStorage
  (function initThemeEarly(){
    try { const t = localStorage.getItem('theme'); if(t) document.body.dataset.theme = t; } catch {}
  })();

  const db = firebase.firestore();
  const alleGroepen = ["Ribbels","Speelclubs","Rakkers","Kwiks","Tippers","Toppers","Aspi","LEIDING"];
  const groepKleuren = {
    Ribbels: "rgba(59,130,246,0.18)",      // blue-500
    Speelclubs: "rgba(234,179,8,0.18)",   // amber-500
    Rakkers: "rgba(34,197,94,0.18)",      // green-500
    Kwiks: "rgba(244,114,182,0.18)",      // pink-400
    Tippers: "rgba(99,102,241,0.18)",     // indigo-500
    Toppers: "rgba(16,185,129,0.18)",     // emerald-500
    Aspi: "rgba(249,115,22,0.18)",        // orange-500
    LEIDING: "rgba(148,163,184,0.18)"     // slate-400
  };

  function kleurVoorGroep(g){
    const key=(g||'').toString().trim().toLowerCase();
    const map={
      ribbels: groepKleuren.Ribbels,
      speelclubs: groepKleuren.Speelclubs,
      rakkers: groepKleuren.Rakkers,
      kwiks: groepKleuren.Kwiks,
      tippers: groepKleuren.Tippers,
      toppers: groepKleuren.Toppers,
      aspi: groepKleuren.Aspi,
      leiding: groepKleuren.LEIDING
    };
    return map[key] || 'rgba(148,163,184,0.12)';
  }

  // Helpers: name/email, theme, IP, audit
  function nameFromEmail(email){ const i=(email||'').indexOf('@'); return (i>0? email.slice(0,i): (email||'-')).trim(); }
  function applyTheme(theme){ document.body.dataset.theme = theme; }
  async function saveThemePreference(theme, uid){ try { localStorage.setItem('theme', theme); if(uid){ await db.collection('gebruikers').doc(uid).set({ theme }, { merge:true }); } } catch {}
  }
  let clientIP=null; async function resolveClientIP(){ try { const c=localStorage.getItem('clientIP'); if(c){ clientIP=c; return c; } const r=await fetch('https://api.ipify.org?format=json'); const j=await r.json(); clientIP=j&&j.ip? j.ip:null; if(clientIP) localStorage.setItem('clientIP', clientIP); return clientIP; } catch { return null; } }
  async function logActie(action, details){ try { const user=firebase.auth().currentUser; const email=user?.email||'-'; const d=await db.collection('gebruikers').doc(user?.uid||'__none__').get().catch(()=>null); const rol=d && d.exists? (d.data().rol||'-') : '-'; const naam=nameFromEmail(email); const emoji= rol==='financieel'? 'ðŸ›¡ï¸':'ðŸ‘¤'; const ip = clientIP || await resolveClientIP(); await db.collection('auditLogs').add({ action, details: details||{}, uid:user?.uid||null, email, naam, rol, isAdmin: rol==='financieel', emoji, ip: ip||null, ua: navigator.userAgent, at: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e) { console.warn('audit log faalde', e);} }

  let gebruikersData = null;
  let ledenMap = {};        // { groep: aantal }
  let totalenPerGroep = {}; // { groep: somBedragen }
  let unsubUitgaven = null, unsubLeden = null;

  const $ = (id) => document.getElementById(id);
  const euro = (n) => `â‚¬${(Number(n)||0).toFixed(2)}`;
  const magBeheren = () => gebruikersData && gebruikersData.rol === 'financieel';

  // Locale-aware parse: supports 12,30 and 12.30
  function parseEuro(input){
    if (typeof input === 'number') return input;
    const s = String(input||'').trim().replace(/\s/g,'');
    if (!s) return NaN;
    const norm = s.replace(/\.(?=\d{3}(\D|$))/g, '').replace(',', '.');
    const v = Number(norm);
    return isNaN(v) ? NaN : v;
  }

  function bouwTabel(){
    const tbody = document.querySelector('#groepSamenvattingTabel tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    alleGroepen.forEach(g => {
      const leden = Number(ledenMap[g] || 0);
      const totaal = Number(totalenPerGroep[g] || 0);
      const perKind = leden > 0 ? (totaal / leden) : null;

      const tr = document.createElement('tr');
  tr.style.backgroundColor = kleurVoorGroep(g);

      const tdGroep = document.createElement('td');
      tdGroep.textContent = g; tr.appendChild(tdGroep);

      const tdLeden = document.createElement('td');
      if (magBeheren()){
        const inp = document.createElement('input');
        inp.type = 'number'; inp.min = '0';
        inp.value = String(leden);
        inp.style.width = '90px';
        const save = () => slaLedenOp(g, inp.value);
        inp.addEventListener('change', save);
        inp.addEventListener('blur', save);
        tdLeden.appendChild(inp);
      } else {
        tdLeden.textContent = String(leden);
      }
      tr.appendChild(tdLeden);

      const tdTotaal = document.createElement('td');
      tdTotaal.textContent = euro(totaal); tr.appendChild(tdTotaal);

      const tdPerKind = document.createElement('td');
      tdPerKind.textContent = perKind != null ? euro(perKind) : '-'; tr.appendChild(tdPerKind);

      tbody.appendChild(tr);
    });
  }

  async function slaLedenOp(groep, value){
    if (!magBeheren()) return;
    const n = Math.max(0, parseInt(value, 10) || 0);
    try {
      await db.collection('config').doc('ledenPerGroep').set({ [groep]: n }, { merge: true });
      ledenMap[groep] = n; // directe feedback
      logActie('leden_aangepast', { groep, leden: n });
      bouwTabel();
    } catch (err){
      console.error('Opslaan leden mislukt:', err);
      const status = $('samenvattingStatus'); if(status) status.textContent = 'Opslaan mislukt: ' + (err?.message || err);
    }
  }

  function startListeners(){
    if (unsubLeden) { unsubLeden(); unsubLeden = null; }
    if (unsubUitgaven) { unsubUitgaven(); unsubUitgaven = null; }

    unsubLeden = db.collection('config').doc('ledenPerGroep').onSnapshot(doc => {
      ledenMap = doc.exists ? (doc.data() || {}) : {};
      bouwTabel();
    }, err => console.warn('ledenPerGroep listener fout:', err));

    unsubUitgaven = db.collection('uitgaven').onSnapshot(snap => {
      const map = {};
      snap.docs.forEach(d => {
        const u = d.data() || {};
        const g = u.groep || 'UNKNOWN';
        const bedrag = parseEuro(u.bedrag) || 0;
        map[g] = (map[g] || 0) + bedrag;
      });
      totalenPerGroep = map;
      bouwTabel();
    }, err => console.error('uitgaven listener fout:', err));
  }

  firebase.auth().onAuthStateChanged(async user => {
    const nav = document.getElementById('mainNav');
    if (nav) nav.style.display = 'none';
    if (user){
      try {
        const d = await db.collection('gebruikers').doc(user.uid).get();
        gebruikersData = d.exists ? d.data() : {};
        // Apply persisted theme if present
        if(gebruikersData && gebruikersData.theme){ applyTheme(gebruikersData.theme); try{localStorage.setItem('theme', gebruikersData.theme);}catch{} }
      } catch { gebruikersData = {}; }

      const login = $('loginScherm'); if(login) login.style.display='none';
      const app = $('appInhoud'); if(app) app.style.display='block';
      if (nav) nav.style.display='flex';
      const navBeh = $('navBeheer'); const navLogout=$('navLogout'); const navTheme=$('navTheme');
      if (navBeh) navBeh.style.display = (gebruikersData.rol === 'financieel') ? 'inline' : 'none';
      if (navLogout) navLogout.style.display = 'inline';
      if (navTheme) { navTheme.style.display='inline'; navTheme.textContent = (document.body.dataset.theme||'dark')==='light'? 'ðŸŒž':'ðŸŒ™'; }
      const info = $('gebruikerInfo'); if(info) info.textContent = `Ingelogd als ${gebruikersData.rol||'-'} (${gebruikersData.groep||'-'})`;

      startListeners();
      bouwTabel();
      logActie('login', {});
    } else {
      if (unsubLeden) { unsubLeden(); unsubLeden=null; }
      if (unsubUitgaven) { unsubUitgaven(); unsubUitgaven=null; }
      gebruikersData=null; ledenMap={}; totalenPerGroep={};
      const app=$('appInhoud'); if(app) app.style.display='none';
      const login=$('loginScherm'); if(login) login.style.display='block';
    }
  });

  const loginBtn = $('loginKnop'); if (loginBtn) loginBtn.addEventListener('click', async () => {
    const email = ($('loginEmail')?.value||'').trim();
    const pass = ($('loginWachtwoord')?.value||'').trim();
    const fout = $('loginFout');
    if(!email || !pass){ if(fout) fout.textContent='Vul e-mail en wachtwoord in.'; return; }
    try {
      await firebase.auth().signInWithEmailAndPassword(email, pass);
      if (fout) fout.textContent='';
    } catch(err){ if(fout) fout.textContent = 'Login mislukt: ' + (err?.message || err); }
  });
  const navLogoutBtn = $('navLogout'); if (navLogoutBtn) navLogoutBtn.addEventListener('click', async ()=> { await logActie('logout',{}); firebase.auth().signOut(); });
  const navThemeBtn = $('navTheme'); if(navThemeBtn) navThemeBtn.addEventListener('click', async ()=>{ const current=document.body.dataset.theme||localStorage.getItem('theme')||'dark'; const next = current==='dark'?'light':'dark'; applyTheme(next); navThemeBtn.textContent = next==='light'? 'ðŸŒž':'ðŸŒ™'; const uid=firebase.auth().currentUser?.uid; await saveThemePreference(next, uid); logActie('theme_changed',{ theme: next }); });
  </script>
</body>
</html>
 









