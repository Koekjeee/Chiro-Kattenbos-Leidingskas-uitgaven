<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Samenvatting – Chiro Kattenbos</title>
<link rel="stylesheet" href="style.css" />
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC-UaXhh5juhV4raXWnzku9fSZZD75-y9w",
  authDomain: "uitgavebeheerch.firebaseapp.com",
  projectId: "uitgavebeheerch",
  storageBucket: "uitgavebeheerch.firebasestorage.app"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>
<body>
<nav id="mainNav" style="display:none; background:#2c3e50; color:#fff; padding:10px 15px; display:flex; align-items:center; gap:15px;">
  <span style="font-weight:600;">Chiro Kattenbos</span>
  <a href="index.html" style="color:#fff; text-decoration:none;">Home</a>
  <a id="navSamenvatting" href="samenvatting.html" style="color:#fff; text-decoration:none; display:none;">Samenvatting</a>
  <a id="navBeheer" href="gebruikersbeheer.html" style="color:#fff; text-decoration:none; display:none;">Gebruikersbeheer</a>
  <button id="navLogout" style="margin-left:auto; background:#e74c3c; color:#fff; border:none; padding:6px 12px; cursor:pointer; display:none;">Uitloggen</button>
</nav>
<div id="loginScherm">
  <h2>Inloggen</h2>
  <input type="email" id="loginEmail" placeholder="E-mailadres" required />
  <input type="password" id="loginWachtwoord" placeholder="Wachtwoord" required />
  <button id="loginKnop">Inloggen</button>
  <p id="loginFout" style="color:red;"></p>
</div>
<div id="appInhoud" style="display:none;">
  <h1>Samenvatting per Groep</h1>
  <p id="gebruikerInfo"></p>
  <button id="logoutKnop" class="top-icon-btn danger" style="display:none;">Uitloggen</button>
  <table id="groepSamenvattingTabel">
    <thead><tr><th>Groep</th><th>Leden</th><th>Totaal (€)</th><th>€ per kind</th></tr></thead>
    <tbody></tbody>
  </table>
  <p id="samenvattingStatus" style="font-style:italic; color:#555; margin-top:8px;"></p>
</div>
<script>
// Realtime samenvatting implementatie
const db = firebase.firestore();
let gebruikersData = null;
let ledenPerGroep = {};
let uitgavenCache = [];
let unsubUitgaven = null;
let unsubLeden = null;

function $(id){ return document.getElementById(id); }
function magBeheren(){ return gebruikersData && gebruikersData.rol === 'financieel'; }

function renderSamenvatting(){
  const tbody = document.querySelector('#groepSamenvattingTabel tbody');
  const statusEl = $('#samenvattingStatus');
  if(!tbody) return;
  tbody.innerHTML='';

  if(!uitgavenCache.length && Object.keys(ledenPerGroep||{}).length===0){
    if(statusEl) statusEl.textContent = 'Nog geen data beschikbaar.';
    return;
  } else if(statusEl) {
    statusEl.textContent = '';
  }

  const groepenSet = new Set([
    ...Object.keys(ledenPerGroep||{}),
    ...uitgavenCache.map(u=>u.groep).filter(Boolean)
  ]);
  const groepen = Array.from(groepenSet).sort();

  const totalen = {};
  uitgavenCache.forEach(u => {
    const g = u.groep || 'UNKNOWN';
    const bedrag = parseFloat(u.bedrag) || 0;
    if(!totalen[g]) totalen[g] = 0;
    totalen[g] += bedrag;
  });

  groepen.forEach(g => {
    const leden = ledenPerGroep[g] || 0;
    const totaal = totalen[g] || 0;
    const perKind = leden > 0 ? (totaal / leden).toFixed(2) : '-';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${g}</td><td>${leden}</td><td>€${totaal.toFixed(2)}</td><td>${perKind}</td>`;
    tbody.appendChild(tr);
  });
}

function startSamenvattingListeners(){
  unsubLeden = db.collection('config').doc('ledenPerGroep').onSnapshot(doc => {
    ledenPerGroep = doc.exists ? (doc.data()||{}) : {};
    renderSamenvatting();
  }, err => console.warn('ledenPerGroep listener fout:', err));

  unsubUitgaven = db.collection('uitgaven').onSnapshot(snap => {
    uitgavenCache = snap.docs.map(d => d.data());
    renderSamenvatting();
  }, err => console.error('uitgaven listener fout:', err));
}

firebase.auth().onAuthStateChanged(async user => {
  if(user){
    const d = await db.collection('gebruikers').doc(user.uid).get();
    gebruikersData = d.exists ? d.data() : {};
    if(!magBeheren()){
      alert('Geen toegang tot deze pagina.');
      firebase.auth().signOut();
      return;
    }
    const loginSchermEl = $('#loginScherm');
    const appInhoudEl = $('#appInhoud');
    if(loginSchermEl) loginSchermEl.style.display='none';
    if(appInhoudEl) appInhoudEl.style.display='block';
    const nav = document.getElementById('mainNav'); if(nav) nav.style.display='flex';
    const navSam=document.getElementById('navSamenvatting'); const navBeh=document.getElementById('navBeheer'); const navLogout=document.getElementById('navLogout');
    if(navSam) navSam.style.display='inline'; if(navBeh) navBeh.style.display='inline'; if(navLogout) navLogout.style.display='inline';
    const infoEl = $('#gebruikerInfo'); if(infoEl) infoEl.textContent = `Ingelogd als ${gebruikersData.rol||'-'} (${gebruikersData.groep||'-'})`;
    startSamenvattingListeners();
  } else {
    if(unsubUitgaven){unsubUitgaven(); unsubUitgaven=null;}
    if(unsubLeden){unsubLeden(); unsubLeden=null;}
    gebruikersData=null; ledenPerGroep={}; uitgavenCache=[];
    const appInhoudEl = $('#appInhoud'); if(appInhoudEl) appInhoudEl.style.display='none';
    const loginSchermEl = $('#loginScherm'); if(loginSchermEl) loginSchermEl.style.display='block';
    const tbody = document.querySelector('#groepSamenvattingTabel tbody'); if(tbody) tbody.innerHTML='';
    const statusEl = $('#samenvattingStatus'); if(statusEl) statusEl.textContent='';
  }
});
// Veilige event listeners (null-checks)
const navLogoutBtn = document.getElementById('navLogout');
if(navLogoutBtn) navLogoutBtn.addEventListener('click', ()=> firebase.auth().signOut());

const loginBtnEl = $('#loginKnop');
if(loginBtnEl) loginBtnEl.addEventListener('click', async () => {
  const emailEl = $('#loginEmail');
  const passEl = $('#loginWachtwoord');
  const foutEl = $('#loginFout');
  const e = emailEl ? emailEl.value.trim() : '';
  const p = passEl ? passEl.value.trim() : '';
  if(!e || !p){ if(foutEl) foutEl.textContent='Vul e-mail en wachtwoord in.'; return; }
  try { await firebase.auth().signInWithEmailAndPassword(e,p); if(foutEl) foutEl.textContent=''; }
  catch(err){ if(foutEl) foutEl.textContent = 'Login mislukt: ' + (err && err.message ? err.message : err); }
});

const logoutKnopEl = $('#logoutKnop');
if(logoutKnopEl) logoutKnopEl.addEventListener('click', ()=> firebase.auth().signOut());
</script>
</body>
</html>


