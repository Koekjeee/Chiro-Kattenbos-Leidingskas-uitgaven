<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gebruikersbeheer â€“ Chiro Kattenbos</title>
<link rel="stylesheet" href="style.css" />
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC-UaXhh5juhV4raXWnzku9fSZZD75-y9w",
  authDomain: "uitgavebeheerch.firebaseapp.com",
  projectId: "uitgavebeheerch",
  storageBucket: "uitgavebeheerch.firebasestorage.app"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>
<body>
  <nav id="mainNav" style="display:none; background:#2c3e50; color:#fff; padding:10px 15px; display:flex; align-items:center; gap:15px;">
    <span style="font-weight:600;">Chiro Kattenbos</span>
    <a href="index.html" style="color:#fff; text-decoration:none;">Home</a>
    <a id="navBeheer" href="gebruikersbeheer.html" style="color:#fff; text-decoration:none; display:none;">Gebruikersbeheer</a>
    <button id="navLogout" style="margin-left:auto; background:#e74c3c; color:#fff; border:none; padding:6px 12px; cursor:pointer; display:none;">Uitloggen</button>
  </nav>
  <div id="loginScherm">
    <h2>Inloggen</h2>
    <input type="email" id="loginEmail" placeholder="E-mailadres" required />
    <input type="password" id="loginWachtwoord" placeholder="Wachtwoord" required />
    <button id="loginKnop">Inloggen</button>
    <p id="loginFout" style="color:red;"></p>
  </div>
  <div id="appInhoud" style="display:none;">
    <h1>Gebruikersbeheer</h1>
    <p id="gebruikerInfo"></p>
  <!-- Floating logout knop verwijderd: we gebruiken de navbar knop -->
    <div id="beheerPaneel">
      <!-- Nieuw: Account aanmaken -->
      <form id="createAccountForm" style="margin-bottom:1rem;">
        <h3>Nieuw account aanmaken</h3>
        <label for="newEmail">E-mailadres:</label>
        <input type="email" id="newEmail" required />
        <label for="newPassword">Wachtwoord:</label>
        <input type="password" id="newPassword" required />
        <label for="newGroep">Groep:</label>
        <select id="newGroep">
          <option value="Ribbels">Ribbels</option><option value="Speelclubs">Speelclubs</option><option value="Rakkers">Rakkers</option><option value="Kwiks">Kwiks</option><option value="Tippers">Tippers</option><option value="Toppers">Toppers</option><option value="Aspi">Aspi</option><option value="LEIDING">LEIDING</option>
        </select>
        <label for="newRol">Rol:</label>
        <select id="newRol"><option value="leiding">Leiding</option><option value="financieel">Financieel</option></select>
        <button type="submit">Account aanmaken</button>
        <p id="createInfo" style="color:#555; font-style:italic; margin-top:6px;"></p>
      </form>

      <form id="rolForm" style="margin-bottom:1rem;">
        <label for="userUid">Gebruiker UID:</label>
        <input type="text" id="userUid" required />
        <label for="userGroep">Groep:</label>
        <select id="userGroep">
          <option value="Ribbels">Ribbels</option><option value="Speelclubs">Speelclubs</option><option value="Rakkers">Rakkers</option><option value="Kwiks">Kwiks</option><option value="Tippers">Tippers</option><option value="Toppers">Toppers</option><option value="Aspi">Aspi</option><option value="LEIDING">LEIDING</option>
        </select>
        <label for="userRol">Rol:</label>
        <select id="userRol"><option value="leiding">Leiding</option><option value="financieel">Financieel</option></select>
        <button type="submit">Opslaan</button>
      </form>
      <table id="gebruikersLijstTabel">
        <thead><tr><th>E-mail</th><th>UID</th><th>Rol</th><th>Groep</th></tr></thead>
        <tbody id="gebruikersLijstBody"></tbody>
      </table>
    </div>
  </div>
<script>
const db = firebase.firestore();
let gebruikersData=null;
function $(id){return document.getElementById(id);} 
function magBeheren(){return gebruikersData && gebruikersData.rol==='financieel';}
firebase.auth().onAuthStateChanged(async user=>{
 if(user){
   const d= await db.collection('gebruikers').doc(user.uid).get();
   gebruikersData = d.exists? d.data():{};
   $("loginScherm").style.display='none';
   $("appInhoud").style.display='block';
   $("gebruikerInfo").textContent=`Ingelogd als ${gebruikersData.rol||'-'} (${gebruikersData.groep||'-'})`;
   if(!magBeheren()){alert('Geen toegang'); firebase.auth().signOut(); return;}
   renderGebruikers();
   document.getElementById('mainNav').style.display='flex';
   const navBeh = document.getElementById('navBeheer');
   const navLogout = document.getElementById('navLogout');
   if(navBeh) navBeh.style.display = 'inline';
   if(navLogout) { 
     navLogout.style.display = 'inline';
     navLogout.addEventListener('click', ()=> firebase.auth().signOut());
   }
 } else {
   $("appInhoud").style.display='none';
   $("loginScherm").style.display='block';
 }
});
$("loginKnop").addEventListener('click',async()=>{const e=$("loginEmail").value.trim();const p=$("loginWachtwoord").value.trim();const f=$("loginFout"); try{await firebase.auth().signInWithEmailAndPassword(e,p);f.textContent='';}catch(err){f.textContent='Login mislukt: '+(err.message||err);} });
// Floating logout knop bestond niet meer
// Bestaande gebruiker updaten
$("rolForm").addEventListener('submit',async ev=>{ev.preventDefault();const uid=$("userUid").value.trim();const groep=$("userGroep").value;const rol=$("userRol").value; if(!uid) return; await db.collection('gebruikers').doc(uid).set({groep,rol},{merge:true}); alert('Opgeslagen'); renderGebruikers();});

// Nieuw account aanmaken via Firebase Identity (REST), zodat huidige admin sessie behouden blijft
$("createAccountForm").addEventListener('submit', async ev => {
  ev.preventDefault();
  if(!magBeheren()) return alert('Geen toegang');
  const email = ($('newEmail')?.value || '').trim();
  const password = ($('newPassword')?.value || '').trim();
  const groep = $('newGroep')?.value || 'LEIDING';
  const rol = $('newRol')?.value || 'leiding';
  const info = $('createInfo');
  if(!email || !password) { if(info) info.textContent = 'Geef e-mail en wachtwoord in.'; return; }

  try {
    if(info) info.textContent = 'Bezig met aanmaken...';
    // Gebruik Firebase Identity Toolkit REST API signUp endpoint
    const apiKey = firebase.app().options.apiKey;
    const res = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${apiKey}`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, password, returnSecureToken: true })
    });
    const data = await res.json();
    if(!res.ok){
      let msg = data && data.error && data.error.message ? data.error.message : 'Onbekende fout';
      // Vertaal enkele bekende codes
      if(msg === 'EMAIL_EXISTS') msg = 'E-mailadres bestaat al';
      if(info) info.textContent = 'Aanmaken mislukt: ' + msg; return;
    }
    const newUid = data.localId;
    // Sla profiel in Firestore
    await db.collection('gebruikers').doc(newUid).set({ email, groep, rol }, { merge: true });
    if(info) info.textContent = 'Account aangemaakt. UID: ' + newUid;
    // Reset formulier en refresh lijst
    $('createAccountForm').reset();
    renderGebruikers();
  } catch(err){
    if(info) info.textContent = 'Aanmaken mislukt: ' + (err && err.message ? err.message : err);
  }
});
async function renderGebruikers(){const tbody=$("gebruikersLijstBody"); tbody.innerHTML=''; const snap=await db.collection('gebruikers').get(); snap.docs.forEach(doc=>{const u=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.email||'-'}</td><td>${doc.id}</td><td>${u.rol||'-'}</td><td>${u.groep||'-'}</td>`; tbody.appendChild(tr);});}
</script>
</body>
</html>




